<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>P2P –í—ñ–¥–µ–æ-—Ä—É–ª–µ—Ç–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:sans-serif; background:#181818; color:#fff; }
    .center { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; }
    .videos {
      display: flex;
      flex-direction: row;
      gap: 10px;
      width: 100%;
      max-width: 400px;
      justify-content: center;
      align-items: flex-end;
    }
    .video-main video {
      width: 260px;
      height: 180px;
      border-radius: 10px;
      background: #333;
      object-fit: cover;
    }
    .video-mini {
      position: relative;
    }
    .video-mini video {
      width: 80px;
      height: 60px;
      border-radius: 8px;
      background: #222;
      object-fit: cover;
      border: 2px solid #00c896;
    }
    @media (max-width:600px) {
      .videos {
        flex-direction: column-reverse;
        align-items: center;
        max-width: 98vw;
      }
      .video-main video {
        width: 98vw;
        height: 200px;
        max-width: 100%;
      }
      .video-mini video {
        width: 90px;
        height: 68px;
        position: absolute;
        right: 8px;
        bottom: 8px;
        border: 2px solid #00c896;
        background: #222;
      }
      .video-mini {
        width: 100%;
        height: 80px;
        position: relative;
      }
    }
    button { padding:10px 20px; margin:12px 0; border:none; border-radius:6px; background:#00c896; color:#fff; font-size:1.1em; cursor:pointer; }
    #nextBtn { background:#ff4b4b; }
    .loader { width:48px; height:48px; border:6px solid #00c896; border-top:6px solid #fff; border-radius:50%; animation:spin 1s linear infinite; margin:24px auto; }
    @keyframes spin { 100% { transform:rotate(360deg); } }
    #contacts { width:100%;max-width:400px;margin-bottom:18px;display:none; }
    #contactsList { padding:0;list-style:none;margin:0 0 8px 0;}
    #contactsList li { padding:5px 8px; border-radius:4px; margin-bottom:2px; cursor:pointer; background:#232323;}
    #contactsList li:hover { background:#00c896; color:#fff; }
    #chat { width:100%;max-width:400px;display:none; }
    #chatMessages { height:120px;overflow-y:auto;background:#222;border-radius:6px;padding:8px;font-size:0.98em;margin-bottom:8px;}
    #chatForm { display:flex;gap:6px;}
    #chatInput { flex:1;border-radius:6px;border:none;padding:8px;}
    #chatForm button { background:#00c896;color:#fff;border:none;border-radius:6px;padding:8px 14px;margin:0;}
    .secure-indicator {
      font-size: 0.95em;
      color: #00c896;
      margin-bottom: 4px;
      text-align: center;
    }
  </style>
</head>
<body>
<div class="center">
  <h2>P2P –í—ñ–¥–µ–æ-—Ä—É–ª–µ—Ç–∫–∞</h2>
  <p style="color:#ccc;max-width:350px;text-align:center;margin-bottom:18px;">
    –ê–Ω–æ–Ω—ñ–º–Ω–∏–π –≤—ñ–¥–µ–æ—á–∞—Ç –¥–ª—è –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö –∑–Ω–∞–π–æ–º—Å—Ç–≤ –∞–±–æ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è –∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –∞–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç!
  </p>
  <div id="contacts">
    <h3 style="margin:8px 0 6px 0;font-size:1.1em;">–ö–æ–Ω—Ç–∞–∫—Ç–∏ –æ–Ω–ª–∞–π–Ω</h3>
    <ul id="contactsList"></ul>
  </div>
  <div id="loader" class="loader"></div>
  <div class="videos" style="display:none;">
    <div class="video-main">
      <video id="remoteVideo" autoplay playsinline></video>
      <div style="text-align:center;font-size:0.9em;color:#aaa;">–°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫</div>
    </div>
    <div class="video-mini">
      <video id="localVideo" autoplay muted playsinline></video>
      <div style="text-align:center;font-size:0.9em;color:#aaa;">–í–∏</div>
    </div>
  </div>
  <button id="startBtn" style="display:none">–í–∏–ø–∞–¥–∫–æ–≤–∏–π —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫</button>
  <button id="nextBtn" style="display:none;">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ / –î–∞–ª—ñ</button>
  <div id="chat">
    <div class="secure-indicator" id="secureIndicator" style="display:none;">üîí –ß–∞—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ</div>
    <div id="chatMessages"></div>
    <form id="chatForm">
      <input id="chatInput" autocomplete="off" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
      <button type="submit">‚Üë</button>
    </form>
  </div>
  <p id="info" style="margin-top:10px"></p>
</div>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const loader = document.getElementById('loader');
const videos = document.querySelector('.videos');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const info = document.getElementById('info');
const contacts = document.getElementById('contacts');
const contactsList = document.getElementById('contactsList');
const chat = document.getElementById('chat');
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
const secureIndicator = document.getElementById('secureIndicator');

let peer, myStream, connPeerId = null, call, dataConn = null;
let contactsArr = [];

// –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—è
let myKeyPair, sharedSecret, peerPublicKey;
let keyExchanged = false;

// –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–ª—é—á—ñ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
async function generateKeys() {
  myKeyPair = await window.crypto.subtle.generateKey(
    { name: "ECDH", namedCurve: "P-256" }, true, ["deriveKey", "deriveBits"]
  );
}

// –ï–∫—Å–ø–æ—Ä—Ç –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞
async function exportPublicKey() {
  return await window.crypto.subtle.exportKey("jwk", myKeyPair.publicKey);
}

// –Ü–º–ø–æ—Ä—Ç –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞
async function importPeerPublicKey(jwk) {
  return await window.crypto.subtle.importKey(
    "jwk", jwk, { name: "ECDH", namedCurve: "P-256" }, true, []
  );
}

// –í–∏—Ä–∞—Ö—É–≤–∞–Ω–Ω—è —Å–ø—ñ–ª—å–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç—É
async function deriveSharedSecret(peerKey) {
  return await window.crypto.subtle.deriveKey(
    { name: "ECDH", public: peerKey },
    myKeyPair.privateKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );
}

// –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
async function encryptMsg(plain, key) {
  const enc = new TextEncoder();
  const iv = window.crypto.getRandomValues(new Uint8Array(12));
  const ciphertext = await window.crypto.subtle.encrypt(
    { name: "AES-GCM", iv }, key, enc.encode(plain)
  );
  return { data: Array.from(new Uint8Array(ciphertext)), iv: Array.from(iv) };
}

// –î–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
async function decryptMsg(cipher, key, iv) {
  try {
    const dec = new TextDecoder();
    const data = new Uint8Array(cipher.data || cipher);
    const ivArr = new Uint8Array(iv);
    const plain = await window.crypto.subtle.decrypt(
      { name: "AES-GCM", iv: ivArr }, key, data
    );
    return dec.decode(plain);
  } catch (e) { return "[–ü–æ–º–∏–ª–∫–∞ –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è]"; }
}

// –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Å–≤—ñ–π –ø—É–±–ª—ñ—á–Ω–∏–π –∫–ª—é—á
async function sendPublicKey() {
  if (dataConn && dataConn.open) {
    const pub = await exportPublicKey();
    dataConn.send({ type: "pubkey", key: pub });
  }
}

// –û–±—Ä–æ–±–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–ª—é—á–∞
async function handlePubkey(msg) {
  peerPublicKey = await importPeerPublicKey(msg.key);
  sharedSecret = await deriveSharedSecret(peerPublicKey);
  keyExchanged = true;
  secureIndicator.style.display = '';
  info.textContent = "–ö–ª—é—á—ñ –æ–±–º—ñ–Ω—è–Ω–æ! –ß–∞—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ.";
}

// –°–∫–∏–¥–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–º—É –∑'—î–¥–Ω–∞–Ω–Ω—ñ
function resetKeys() {
  sharedSecret = null;
  peerPublicKey = null;
  keyExchanged = false;
  secureIndicator.style.display = 'none';
}

// --- PeerJS –ª–æ–≥—ñ–∫–∞ ---
async function start() {
  loader.style.display = '';
  info.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –º–µ—Ä–µ–∂—ñ...';
  await generateKeys();
  try {
    myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
    localVideo.srcObject = myStream;
  } catch(e) {
    info.textContent = '–î–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏/–º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ!';
    loader.style.display = 'none';
    return;
  }
  peer = new Peer();
  peer.on('open', id => {
    loader.style.display = 'none';
    startBtn.style.display = '';
    info.textContent = '–ì–æ—Ç–æ–≤–æ! –û–±–µ—Ä—ñ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –≤–∏–±–æ—Ä—É.';
    loadContacts();
    setInterval(loadContacts, 10000);
  });

  peer.on('call', incomingCall => {
    endCall();
    call = incomingCall;
    call.answer(myStream);
    call.on('stream', stream => remoteVideo.srcObject = stream);
    call.on('close', handleCallClose);
    showVideos();
  });

  peer.on('connection', conn => {
    if (dataConn) dataConn.close();
    dataConn = conn;
    resetKeys();
    dataConn.on('open', async () => {
      await sendPublicKey();
    });
    dataConn.on('data', async msg => {
      if (msg && msg.type === "pubkey") {
        await handlePubkey(msg);
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Å–≤—ñ–π –∫–ª—é—á —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å, —è–∫—â–æ —â–µ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏
        if (!keyExchanged) await sendPublicKey();
        return;
      }
      if (msg && msg.type === "msg") {
        if (sharedSecret) {
          const plain = await decryptMsg(msg.data, sharedSecret, msg.iv);
          addChatMessage('–í—ñ–Ω/–í–æ–Ω–∞', plain);
        } else {
          addChatMessage('–í—ñ–Ω/–í–æ–Ω–∞', "[–ù–µ–º–∞—î –∫–ª—é—á–∞!]");
        }
        return;
      }
    });
    dataConn.on('close', () => { chat.style.display = 'none'; resetKeys(); });
    chat.style.display = '';
    info.textContent = '–ß–∞—Ç –∑ ' + conn.peer;
  });
}

function showVideos() {
  videos.style.display = '';
  loader.style.display = 'none';
  info.textContent = '–ó‚Äô—î–¥–Ω–∞–Ω–æ!';
  nextBtn.style.display = '';
}

function endCall() {
  if (call) { call.close(); call = null; }
  remoteVideo.srcObject = null;
  videos.style.display = 'none';
  nextBtn.style.display = 'none';
}

function handleCallClose() {
  info.textContent = '–°–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫ –≤—ñ–¥–∫–ª—é—á–∏–≤—Å—è.';
  endCall();
}

nextBtn.onclick = () => {
  endCall();
  if (dataConn) { dataConn.close(); dataConn = null; chat.style.display = 'none'; resetKeys(); }
  info.textContent = '–†–æ–∑–º–æ–≤—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ.';
  startBtn.style.display = '';
};

function updateContacts(peers) {
  contactsArr = peers.filter(id => id !== peer.id);
  contactsList.innerHTML = '';
  contactsArr.forEach(id => {
    const li = document.createElement('li');
    li.textContent = id;
    li.onclick = () => connectToPeer(id);
    contactsList.appendChild(li);
  });
  contacts.style.display = contactsArr.length ? '' : 'none';
}

function loadContacts() {
  fetch('https://0.peerjs.com/peers').then(r=>r.json()).then(peers=>{
    updateContacts(peers);
  }).catch(()=>{});
}

// –í–∏–ø–∞–¥–∫–æ–≤–∏–π —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫
startBtn.onclick = async () => {
  startBtn.style.display = 'none';
  loader.style.display = '';
  info.textContent = '–ü–æ—à—É–∫...';
  fetch('https://0.peerjs.com/peers').then(r=>r.json()).then(peers=>{
    const others = peers.filter(id=>id!==peer.id);
    if(!others.length) {
      info.textContent = '–ù–µ–º–∞—î —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫—ñ–≤. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ.';
      loader.style.display='none';
      startBtn.style.display='';
      return;
    }
    connPeerId = others[Math.floor(Math.random()*others.length)];
    connectToPeer(connPeerId, true);
  }).catch(()=>{
    info.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ.'; loader.style.display='none'; startBtn.style.display='';
  });
};

// –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –≤–∏–±—Ä–∞–Ω–æ–≥–æ peer
function connectToPeer(id, isRandom = false) {
  endCall();
  if (dataConn) { dataConn.close(); dataConn = null; chat.style.display = 'none'; resetKeys(); }
  info.textContent = isRandom ? '–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è...' : '–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è –∑ ' + id + '...';
  loader.style.display = '';
  // –í—ñ–¥–µ–æ
  call = peer.call(id, myStream);
  call.on('stream', stream => remoteVideo.srcObject = stream);
  call.on('close', handleCallClose);
  showVideos();
  // –ß–∞—Ç
  dataConn = peer.connect(id);
  resetKeys();
  dataConn.on('open', async () => {
    await sendPublicKey();
  });
  dataConn.on('data', async msg => {
    if (msg && msg.type === "pubkey") {
      await handlePubkey(msg);
      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Å–≤—ñ–π –∫–ª—é—á —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å, —è–∫—â–æ —â–µ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏
      if (!keyExchanged) await sendPublicKey();
      return;
    }
    if (msg && msg.type === "msg") {
      if (sharedSecret) {
        const plain = await decryptMsg(msg.data, sharedSecret, msg.iv);
        addChatMessage('–í—ñ–Ω/–í–æ–Ω–∞', plain);
      } else {
        addChatMessage('–í—ñ–Ω/–í–æ–Ω–∞', "[–ù–µ–º–∞—î –∫–ª—é—á–∞!]");
      }
      return;
    }
  });
  dataConn.on('close', () => { chat.style.display = 'none'; resetKeys(); });
  chat.style.display = '';
  info.textContent = '–ß–∞—Ç –∑ ' + id;
}

// –ß–∞—Ç
chatForm.onsubmit = async e => {
  e.preventDefault();
  if (!chatInput.value || !dataConn || dataConn.open === false || !sharedSecret) return;
  addChatMessage('–í–∏', chatInput.value);
  const encrypted = await encryptMsg(chatInput.value, sharedSecret);
  dataConn.send({ type: "msg", data: encrypted.data, iv: encrypted.iv });
  chatInput.value = '';
};
function addChatMessage(from, text) {
  chatMessages.innerHTML += `<div><b>${from}:</b> ${escapeHtml(text)}</div>`;
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function escapeHtml(text) {
  return text.replace(/[<>&"]/g, c => ({
    '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'
  }[c]));
}

start();
</script>
</body>
</html>
