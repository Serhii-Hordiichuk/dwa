<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>P2P Месенджер на PeerJS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background: #222; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 400px; margin: 30px auto; background: #292929; border-radius: 10px; box-shadow: 0 0 10px #0008; padding: 20px; }
    h2 { text-align: center; }
    #my-id { width: 100%; margin-bottom: 10px; font-size: 1.1em; background: #333; color: #fff; border: none; text-align: center; }
    #remote-id { width: 70%; padding: 7px; border-radius: 5px; border: none; margin-bottom: 10px; }
    #connect { width: 27%; padding: 8px; border-radius: 5px; border: none; background: #3a8; color: #fff; font-weight: bold; cursor: pointer; }
    #chat { height: 250px; background: #181818; border-radius: 8px; margin-bottom: 10px; overflow-y: auto; padding: 10px; font-size: 1em; }
    .msg { margin: 5px 0; }
    .msg.me { text-align: right; color: #8fd; }
    .msg.peer { text-align: left; color: #fff; }
    #message { width: 75%; padding: 7px; border-radius: 5px; border: none; }
    #send { width: 22%; padding: 8px; border-radius: 5px; border: none; background: #3a8; color: #fff; font-weight: bold; cursor: pointer; }
    #status { font-size: 0.95em; color: #8fd; margin-bottom: 10px; text-align: center; }
    @media (max-width: 500px) {
      .container { max-width: 98vw; padding: 6vw 2vw; }
      #chat { height: 40vw; min-height: 120px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>P2P Месенджер</h2>
    <input id="my-id" readonly value="Отримую ваш Peer ID...">
    <div style="margin-bottom:10px;">
      <input id="remote-id" placeholder="ID співрозмовника">
      <button id="connect">Зʼєднатись</button>
    </div>
    <div id="status">Очікування зʼєднання...</div>
    <div id="chat"></div>
    <div>
      <input id="message" placeholder="Введіть повідомлення">
      <button id="send">Надіслати</button>
    </div>
  </div>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script>
    const myIdInput = document.getElementById('my-id');
    const remoteIdInput = document.getElementById('remote-id');
    const connectBtn = document.getElementById('connect');
    const status = document.getElementById('status');
    const chat = document.getElementById('chat');
    const msgInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    let conn = null;
    let peer = null;

    function addMsg(text, cls) {
      const div = document.createElement('div');
      div.className = 'msg ' + cls;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function setStatus(text, color = '#8fd') {
      status.textContent = text;
      status.style.color = color;
    }

    function resetChat() {
      chat.innerHTML = '';
      setStatus('Очікування зʼєднання...');
    }

    // 1. Створюємо Peer
    peer = new Peer(undefined, { debug: 2 });
    peer.on('open', id => {
      myIdInput.value = id;
      setStatus('Ваш Peer ID: ' + id, '#8fd');
    });

    // 2. Приймаємо вхідне зʼєднання
    peer.on('connection', c => {
      if (conn) { c.close(); return; }
      conn = c;
      setStatus('Підключено до: ' + conn.peer, '#8fd');
      setupConn();
    });

    // 3. Кнопка "Зʼєднатись"
    connectBtn.onclick = () => {
      if (conn) conn.close();
      resetChat();
      setStatus('Зʼєднання...');
      conn = peer.connect(remoteIdInput.value.trim());
      setupConn();
    };

    // 4. Надсилання повідомлення
    sendBtn.onclick = sendMsg;
    msgInput.onkeydown = e => { if (e.key === 'Enter') sendMsg(); };

    function sendMsg() {
      const text = msgInput.value.trim();
      if (text && conn && conn.open) {
        conn.send(text);
        addMsg('Ви: ' + text, 'me');
        msgInput.value = '';
      }
    }

    function setupConn() {
      if (!conn) return;
      conn.on('open', () => {
        setStatus('Підключено до: ' + conn.peer, '#8fd');
        addMsg('Зʼєднання встановлено!', 'peer');
      });
      conn.on('data', data => {
        addMsg('Співрозмовник: ' + data, 'peer');
      });
      conn.on('close', () => {
        setStatus('Зʼєднання закрито', 'orange');
        addMsg('Зʼєднання закрито', 'peer');
        conn = null;
      });
      conn.on('error', err => {
        setStatus('Помилка: ' + err, 'red');
      });
    }
  </script>
</body>
</html>
